import { FormArray } from "@angular/forms";
import { VALUE_CHANGED_SYNC, PATCH } from "../const/app.const";
import { isMatched, clone } from './entity.service';
import { ObjectMaker } from '../util/object-maker';
const PROP_ARRAY = "propArray";
export class RxFormArray extends FormArray {
    constructor(arrayObject, controls, validatorOrOpts, asyncValidator, arrayConfig) {
        super(controls, validatorOrOpts, asyncValidator);
        this.arrayObject = arrayObject;
        this.arrayConfig = arrayConfig;
        this._isModified = false;
        this._modified = [];
        this.cloneObject(arrayObject);
    }
    get isModified() {
        return this._isModified;
    }
    push(control, options = { isAddedInstance: false }) {
        let formGroup = this.root;
        if (this.arrayObject)
            if (control.modelInstance) {
                if (!options.isAddedInstance)
                    this.arrayObject.push(control.modelInstance);
                else
                    this.arrayObject[this.arrayObject.length] = control.modelInstance;
            }
        super.push(control);
        if (formGroup[VALUE_CHANGED_SYNC])
            formGroup.valueChangedSync();
        this.patch();
        this.checkValidation();
    }
    patch() {
        this.checkModification();
        if (this.parent)
            this.parent[PATCH]();
    }
    resetForm(options) {
        if (options && options.index >= 0 && options.groupOption) {
            this.controls[options.index].resetForm(options.groupOption);
        }
        else {
            for (var i = 0; i < this._baseValue.length; i++) {
                if (this.controls[i] !== undefined)
                    this.controls[i].resetForm({ value: this._baseValue[i] });
                else if (options && options.pushFunction) {
                    let formGroup = options.pushFunction(this._baseValue[i]);
                    this.push(formGroup);
                }
            }
        }
    }
    commit() {
        this._baseValue = [];
        for (let formGroup of this.controls) {
            formGroup.commit();
            this._baseValue.push(clone(formGroup.value));
        }
        this.patch();
    }
    removeAt(index, options = { isRemovedInstance: false }) {
        let formGroup = this.root;
        if (!options.isRemovedInstance)
            this.arrayObject.splice(index, 1);
        else {
            for (var i = index; i < this.arrayObject.length - 1; i++)
                this.arrayObject[i] = this.arrayObject[i + 1];
            this.arrayObject.pop();
        }
        super.removeAt(index, options);
        if (formGroup[VALUE_CHANGED_SYNC])
            formGroup.valueChangedSync();
        this.patch();
        this.checkValidation();
    }
    checkValidation() {
        setTimeout(() => {
            if (this.arrayConfig != undefined && this.arrayConfig.allowMaxIndex && this.length > this.arrayConfig.allowMaxIndex)
                this.setErrors(ObjectMaker.toJson(PROP_ARRAY, this.arrayConfig, [this.length, this.arrayConfig.allowMaxIndex]));
            else if (this.errors && this.errors[PROP_ARRAY])
                delete this.errors[PROP_ARRAY];
        });
    }
    checkModification() {
        this._isModified = !(this._baseValue.length == this.controls.length);
        if (!this._isModified)
            for (var i = 0; i < this.controls.length; i++) {
                this._isModified = isMatched(this._baseValue[i], this.controls[i].value);
                if (this._isModified)
                    break;
            }
    }
    cloneObject(value) {
        this._baseValue = [];
        for (let row of value) {
            this._baseValue.push(clone(row));
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicngtZm9ybS1hcnJheS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL3JlYWN0aXZlLWZvcm0tdmFsaWRhdG9ycy9zZXJ2aWNlcy9yeC1mb3JtLWFycmF5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUVuRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFDbEQsTUFBTSxVQUFVLEdBQVcsV0FBVyxDQUFDO0FBQ3ZDLE1BQU0sT0FBTyxXQUFZLFNBQVEsU0FBUztJQUl0QyxZQUFvQixXQUFrQixFQUFFLFFBQVEsRUFBRSxlQUFxQixFQUFFLGNBQW9CLEVBQVUsV0FBNkQ7UUFDaEssS0FBSyxDQUFDLFFBQVEsRUFBRSxlQUFlLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFEakMsZ0JBQVcsR0FBWCxXQUFXLENBQU87UUFBaUUsZ0JBQVcsR0FBWCxXQUFXLENBQWtEO1FBRjVKLGdCQUFXLEdBQVksS0FBSyxDQUFDO1FBQzdCLGNBQVMsR0FBVSxFQUFFLENBQUM7UUFHMUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsSUFBSSxVQUFVO1FBQ1YsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzVCLENBQUM7SUFFUSxJQUFJLENBQUMsT0FBWSxFQUFFLFVBR3hCLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBQztRQUN6QixJQUFJLFNBQVMsR0FBUSxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQy9CLElBQUksSUFBSSxDQUFDLFdBQVc7WUFDaEIsSUFBSSxPQUFPLENBQUMsYUFBYSxFQUFFO2dCQUN2QixJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWU7b0JBQ3hCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQzs7b0JBRTdDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFBO2FBQ3hFO1FBRUwsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNwQixJQUFJLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQztZQUM3QixTQUFTLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQTtRQUNoQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUE7UUFDWixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUE7SUFDMUIsQ0FBQztJQUVELEtBQUs7UUFDRCxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUN6QixJQUFJLElBQUksQ0FBQyxNQUFNO1lBQ1gsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO0lBRTdCLENBQUM7SUFFRCxTQUFTLENBQUMsT0FRVDtRQUNHLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxLQUFLLElBQUksQ0FBQyxJQUFJLE9BQU8sQ0FBQyxXQUFXLEVBQUU7WUFDaEQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFFLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQTtTQUNyRTthQUFNO1lBQ0gsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUM3QyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssU0FBUztvQkFDeEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUUsQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7cUJBRWpFLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxZQUFZLEVBQUU7b0JBQ2pDLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUN6RCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2lCQUN4QjthQUNSO1NBQ0o7SUFDTCxDQUFDO0lBSUQsTUFBTTtRQUNGLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFBO1FBQ3BCLEtBQUssSUFBSSxTQUFTLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUMzQixTQUFVLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDMUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQ2hEO1FBQ0QsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2pCLENBQUM7SUFHUSxRQUFRLENBQUMsS0FBYSxFQUFFLFVBQWdFLEVBQUUsaUJBQWlCLEVBQUUsS0FBSyxFQUFFO1FBQ3pILElBQUksU0FBUyxHQUFRLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDL0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUI7WUFDMUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ2pDO1lBQ0QsS0FBSyxJQUFJLENBQUMsR0FBRyxLQUFLLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUU7Z0JBQ3BELElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDbEQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztTQUMxQjtRQUdELEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzlCLElBQUksU0FBUyxDQUFDLGtCQUFrQixDQUFDO1lBQzdCLFNBQVMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO1FBQ2hDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtRQUNaLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRU8sZUFBZTtRQUNuQixVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ1osSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLFNBQVMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYTtnQkFDL0csSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDL0csSUFBSSxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDO2dCQUMzQyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0lBRU8saUJBQWlCO1FBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDckUsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXO1lBQ2pCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDM0MsSUFBSSxDQUFDLFdBQVcsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFBO2dCQUN4RSxJQUFJLElBQUksQ0FBQyxXQUFXO29CQUNoQixNQUFNO2FBQ2I7SUFDVCxDQUFDO0lBRU8sV0FBVyxDQUFDLEtBQVk7UUFDNUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDckIsS0FBSyxJQUFJLEdBQUcsSUFBSSxLQUFLLEVBQUU7WUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDcEM7SUFDTCxDQUFDO0NBR0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGb3JtQXJyYXkgfSBmcm9tIFwiQGFuZ3VsYXIvZm9ybXNcIjtcclxuaW1wb3J0IHsgVkFMVUVfQ0hBTkdFRF9TWU5DLCBQQVRDSCB9IGZyb20gXCIuLi9jb25zdC9hcHAuY29uc3RcIjtcclxuaW1wb3J0IHsgaXNNYXRjaGVkLCBjbG9uZSB9IGZyb20gJy4vZW50aXR5LnNlcnZpY2UnXHJcbmltcG9ydCB7IFJlc2V0Rm9ybVR5cGUgfSBmcm9tIFwiLi4vZW51bXMvcmVzZXQtdHlwZVwiO1xyXG5pbXBvcnQgeyBPYmplY3RNYWtlciB9IGZyb20gJy4uL3V0aWwvb2JqZWN0LW1ha2VyJ1xyXG5jb25zdCBQUk9QX0FSUkFZOiBzdHJpbmcgPSBcInByb3BBcnJheVwiO1xyXG5leHBvcnQgY2xhc3MgUnhGb3JtQXJyYXkgZXh0ZW5kcyBGb3JtQXJyYXkge1xyXG4gICAgcHJpdmF0ZSBfYmFzZVZhbHVlOiBhbnlbXTtcclxuICAgIHByaXZhdGUgX2lzTW9kaWZpZWQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByaXZhdGUgX21vZGlmaWVkOiBhbnlbXSA9IFtdO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcnJheU9iamVjdDogYW55W10sIGNvbnRyb2xzLCB2YWxpZGF0b3JPck9wdHM/OiBhbnksIGFzeW5jVmFsaWRhdG9yPzogYW55LCBwcml2YXRlIGFycmF5Q29uZmlnPzogeyBhbGxvd01heEluZGV4PzogbnVtYmVyLCBtZXNzYWdlS2V5Pzogc3RyaW5nIH0pIHtcclxuICAgICAgICBzdXBlcihjb250cm9scywgdmFsaWRhdG9yT3JPcHRzLCBhc3luY1ZhbGlkYXRvcik7XHJcbiAgICAgICAgdGhpcy5jbG9uZU9iamVjdChhcnJheU9iamVjdCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGlzTW9kaWZpZWQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzTW9kaWZpZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgcHVzaChjb250cm9sOiBhbnksIG9wdGlvbnM6IHtcclxuICAgICAgICBlbWl0RXZlbnQ/OiBib29sZWFuLFxyXG4gICAgICAgIGlzQWRkZWRJbnN0YW5jZTogYm9vbGVhbiBcclxuICAgIH0gPSB7IGlzQWRkZWRJbnN0YW5jZTogZmFsc2V9KSB7XHJcbiAgICAgICAgbGV0IGZvcm1Hcm91cDogYW55ID0gdGhpcy5yb290O1xyXG4gICAgICAgIGlmICh0aGlzLmFycmF5T2JqZWN0KVxyXG4gICAgICAgICAgICBpZiAoY29udHJvbC5tb2RlbEluc3RhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMuaXNBZGRlZEluc3RhbmNlKVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXJyYXlPYmplY3QucHVzaChjb250cm9sLm1vZGVsSW5zdGFuY2UpO1xyXG4gICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXJyYXlPYmplY3RbdGhpcy5hcnJheU9iamVjdC5sZW5ndGhdID0gY29udHJvbC5tb2RlbEluc3RhbmNlXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgc3VwZXIucHVzaChjb250cm9sKTtcclxuICAgICAgICBpZiAoZm9ybUdyb3VwW1ZBTFVFX0NIQU5HRURfU1lOQ10pXHJcbiAgICAgICAgICAgIGZvcm1Hcm91cC52YWx1ZUNoYW5nZWRTeW5jKClcclxuICAgICAgICB0aGlzLnBhdGNoKClcclxuICAgICAgICB0aGlzLmNoZWNrVmFsaWRhdGlvbigpXHJcbiAgICB9XHJcblxyXG4gICAgcGF0Y2goKSB7XHJcbiAgICAgICAgdGhpcy5jaGVja01vZGlmaWNhdGlvbigpO1xyXG4gICAgICAgIGlmICh0aGlzLnBhcmVudClcclxuICAgICAgICAgICAgdGhpcy5wYXJlbnRbUEFUQ0hdKCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHJlc2V0Rm9ybShvcHRpb25zPzoge1xyXG4gICAgICAgIGluZGV4OiBudW1iZXIsXHJcbiAgICAgICAgZ3JvdXBPcHRpb246IHtcclxuICAgICAgICAgICAgcmVzZXRUeXBlPzogUmVzZXRGb3JtVHlwZSxcclxuICAgICAgICAgICAgd2l0aD86IHN0cmluZ1tdLFxyXG4gICAgICAgICAgICB2YWx1ZT86IHsgW2tleTogc3RyaW5nXTogYW55IH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIHB1c2hGdW5jdGlvbjogKHZhbHVlOiBPYmplY3QpID0+IGJvb2xlYW47XHJcbiAgICB9KSB7XHJcbiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5pbmRleCA+PSAwICYmIG9wdGlvbnMuZ3JvdXBPcHRpb24pIHtcclxuICAgICAgICAgICAgKDxhbnk+dGhpcy5jb250cm9sc1tvcHRpb25zLmluZGV4XSkucmVzZXRGb3JtKG9wdGlvbnMuZ3JvdXBPcHRpb24pXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9iYXNlVmFsdWUubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvbnRyb2xzW2ldICE9PSB1bmRlZmluZWQpXHJcbiAgICAgICAgICAgICAgICAgICAgKDxhbnk+dGhpcy5jb250cm9sc1tpXSkucmVzZXRGb3JtKHsgdmFsdWU6IHRoaXMuX2Jhc2VWYWx1ZVtpXSB9KTtcclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnB1c2hGdW5jdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZm9ybUdyb3VwID0gb3B0aW9ucy5wdXNoRnVuY3Rpb24odGhpcy5fYmFzZVZhbHVlW2ldKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXNoKGZvcm1Hcm91cCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcblxyXG4gICAgY29tbWl0KCkge1xyXG4gICAgICAgIHRoaXMuX2Jhc2VWYWx1ZSA9IFtdXHJcbiAgICAgICAgZm9yIChsZXQgZm9ybUdyb3VwIG9mIHRoaXMuY29udHJvbHMpIHtcclxuICAgICAgICAgICAgKDxhbnk+Zm9ybUdyb3VwKS5jb21taXQoKTtcclxuICAgICAgICAgICAgdGhpcy5fYmFzZVZhbHVlLnB1c2goY2xvbmUoZm9ybUdyb3VwLnZhbHVlKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMucGF0Y2goKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgb3ZlcnJpZGUgcmVtb3ZlQXQoaW5kZXg6IG51bWJlciwgb3B0aW9uczogeyBlbWl0RXZlbnQ/OiBib29sZWFuLCBpc1JlbW92ZWRJbnN0YW5jZT86IGJvb2xlYW4gfSA9IHsgaXNSZW1vdmVkSW5zdGFuY2U6IGZhbHNlIH0pIHtcclxuICAgICAgICBsZXQgZm9ybUdyb3VwOiBhbnkgPSB0aGlzLnJvb3Q7XHJcbiAgICAgICAgaWYgKCFvcHRpb25zLmlzUmVtb3ZlZEluc3RhbmNlKVxyXG4gICAgICAgICAgICB0aGlzLmFycmF5T2JqZWN0LnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSBpbmRleDsgaSA8IHRoaXMuYXJyYXlPYmplY3QubGVuZ3RoIC0gMTsgaSsrKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5hcnJheU9iamVjdFtpXSA9IHRoaXMuYXJyYXlPYmplY3RbaSArIDFdO1xyXG4gICAgICAgICAgICB0aGlzLmFycmF5T2JqZWN0LnBvcCgpO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIHN1cGVyLnJlbW92ZUF0KGluZGV4LG9wdGlvbnMpO1xyXG4gICAgICAgIGlmIChmb3JtR3JvdXBbVkFMVUVfQ0hBTkdFRF9TWU5DXSlcclxuICAgICAgICAgICAgZm9ybUdyb3VwLnZhbHVlQ2hhbmdlZFN5bmMoKVxyXG4gICAgICAgIHRoaXMucGF0Y2goKVxyXG4gICAgICAgIHRoaXMuY2hlY2tWYWxpZGF0aW9uKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjaGVja1ZhbGlkYXRpb24oKSB7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmFycmF5Q29uZmlnICE9IHVuZGVmaW5lZCAmJiB0aGlzLmFycmF5Q29uZmlnLmFsbG93TWF4SW5kZXggJiYgdGhpcy5sZW5ndGggPiB0aGlzLmFycmF5Q29uZmlnLmFsbG93TWF4SW5kZXgpXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldEVycm9ycyhPYmplY3RNYWtlci50b0pzb24oUFJPUF9BUlJBWSwgdGhpcy5hcnJheUNvbmZpZywgW3RoaXMubGVuZ3RoLCB0aGlzLmFycmF5Q29uZmlnLmFsbG93TWF4SW5kZXhdKSk7XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZXJyb3JzICYmIHRoaXMuZXJyb3JzW1BST1BfQVJSQVldKVxyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuZXJyb3JzW1BST1BfQVJSQVldO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjaGVja01vZGlmaWNhdGlvbigpIHtcclxuICAgICAgICB0aGlzLl9pc01vZGlmaWVkID0gISh0aGlzLl9iYXNlVmFsdWUubGVuZ3RoID09IHRoaXMuY29udHJvbHMubGVuZ3RoKTtcclxuICAgICAgICBpZiAoIXRoaXMuX2lzTW9kaWZpZWQpXHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jb250cm9scy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5faXNNb2RpZmllZCA9IGlzTWF0Y2hlZCh0aGlzLl9iYXNlVmFsdWVbaV0sIHRoaXMuY29udHJvbHNbaV0udmFsdWUpXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5faXNNb2RpZmllZClcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2xvbmVPYmplY3QodmFsdWU6IGFueVtdKSB7XHJcbiAgICAgICAgdGhpcy5fYmFzZVZhbHVlID0gW107XHJcbiAgICAgICAgZm9yIChsZXQgcm93IG9mIHZhbHVlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2Jhc2VWYWx1ZS5wdXNoKGNsb25lKHJvdykpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG59XHJcbiJdfQ==