import { IsNullOrEmpty } from './helpers.class';
import { FileUploadTypes } from './file-types.class';
/**
 * function used to check file size
 */
const checkFileSize = (actualSize, maxSize, minSize = 0, file) => {
    return (!IsNullOrEmpty(maxSize) && actualSize > maxSize) || actualSize < minSize ?
        { maxSize, minSize, actual: actualSize, file } : null;
};
const getFileType = (file, fileExtension) => {
    const type = file.type;
    if (!IsNullOrEmpty(type)) {
        return type;
    }
    return FileUploadTypes[fileExtension];
};
var CheckType;
(function (CheckType) {
    CheckType[CheckType["ALLOWED"] = 0] = "ALLOWED";
    CheckType[CheckType["NOTALLOWED"] = 1] = "NOTALLOWED";
})(CheckType || (CheckType = {}));
const FILE_EXT_REG = /(^[.]\w*)$/m;
/**
 * function used to check file type
 *
 * #### allowedTypes
 * file_extension|audio/*|video/*|image/*|media_type
 */
const checkFileTypes = (file, types, checkType) => {
    const fileExtension = file.name.split('.').pop().toLowerCase();
    const fileType = getFileType(file, fileExtension);
    for (const type of types) {
        const isFound = FILE_EXT_REG.test(type) ? type === `.${fileExtension}` : new RegExp(type).test(fileType);
        if (isFound) {
            return checkType === CheckType.ALLOWED ? null : { notAllowedTypes: types, actual: fileType, file };
        }
    }
    return checkType === CheckType.ALLOWED ? { allowedTypes: types, actual: fileType, file } : null;
};
const checkValueType = (value) => {
    if (!Array.isArray(value)) {
        throw Error(`FormControl.setValue was provided with wrong argument type, ${value} was provided instead Array<File>`);
    }
};
// @dynamic
export class FileUploadValidators {
    /**
     * Validator that compare the summary size of all files
     */
    static sizeLimit(maxSize) {
        return (control) => {
            const files = control.value;
            if (IsNullOrEmpty(files)) {
                return null;
            }
            checkValueType(files);
            const sum = files.map(file => file.size).reduce((a, b) => a + b, 0);
            const toLargeFiles = checkFileSize(sum, maxSize);
            return toLargeFiles ?
                { 'sizeLimit': toLargeFiles } : null;
        };
    }
    /**
     * Validator that validate individually file maximum size length.
     * Compare the File size in bytes
     * @dynamic
     */
    static fileSize(maxSize) {
        return (control) => {
            const files = control.value;
            if (IsNullOrEmpty(files)) {
                return null;
            }
            checkValueType(files);
            const toLargeFiles = files.map((file) => checkFileSize(file.size, maxSize, 0, file))
                .filter((error) => error);
            return toLargeFiles.length > 0 ?
                { 'fileSize': toLargeFiles } : null;
        };
    }
    /**
     * Compare the File size in bytes with max and min size limits
     * @dynamic
     */
    static sizeRange({ minSize, maxSize }) {
        return (control) => {
            const files = control.value;
            if (IsNullOrEmpty(files)) {
                return null;
            }
            checkValueType(files);
            const sizeMismatch = files.map((file) => checkFileSize(file.size, maxSize, minSize, file))
                .filter((error) => error);
            return sizeMismatch.length > 0 ?
                { 'sizeRange': sizeMismatch } : null;
        };
    }
    /**
     * validator that requires control to have limit on files number
     * @dynamic
     */
    static filesLimit(numFiles) {
        return (control) => {
            const files = control.value;
            if (IsNullOrEmpty(files)) {
                return null;
            }
            checkValueType(files);
            const filesLimit = files.slice(-1 * (files.length - numFiles))
                .map(file => ({ 'max': numFiles, 'actual': files.length, file }));
            return files.length > numFiles ?
                { 'filesLimit': filesLimit } : null;
        };
    }
    /**
     * validator that requires control to have limit on media types
     *
     * ##### Allowed media types are
     *
     * - file_extension - a file extension starting with the STOP character,
     * e.g: .gif, .jpg, .png, .doc
     * - audio/* -        All sound files are accepted
     * - video/* -        All video files are accepted
     * - image/* -        All image files are accepted
     * - media_type -     A valid media type, with no parameters. Look at [IANA Media Types]
     *      (https://www.iana.org/assignments/media-types/media-types.xhtml) for a complete list of standard media types
     *
     * #### Example
     * `FileUploadValidators.accept([file_extension, audio/*, video/*, image/*, media_type])`
     * @dynamic
     */
    static accept(allowedFileTypes) {
        return (control) => {
            const files = control.value;
            if (IsNullOrEmpty(files)) {
                return null;
            }
            checkValueType(files);
            const notAllowedFiles = files.map((file) => checkFileTypes(file, allowedFileTypes, CheckType.ALLOWED))
                .filter((error) => error);
            return notAllowedFiles.length > 0 ?
                { 'fileTypes': notAllowedFiles } : null;
        };
    }
    /**
     * validator that requires control to have limit on media types
     *
     * ##### Not allowed media types are
     *
     * - file_extension - a file extension starting with the STOP character,
     * e.g: .gif, .jpg, .png, .doc
     * - audio/* -        All sound files are accepted
     * - video/* -        All video files are accepted
     * - image/* -        All image files are accepted
     * - media_type -     A valid media type, with no parameters. Look at [IANA Media Types]
     *      (https://www.iana.org/assignments/media-types/media-types.xhtml) for a complete list of standard media types
     *
     * #### Example
     * `FileUploadValidators.reject([file_extension, audio/*, video/*, image/*, media_type])`
     * @dynamic
     */
    static reject(rejectFileTypes) {
        return (control) => {
            const files = control.value;
            if (IsNullOrEmpty(files)) {
                return null;
            }
            checkValueType(files);
            const notAllowedFiles = files.map((file) => checkFileTypes(file, rejectFileTypes, CheckType.NOTALLOWED))
                .filter((error) => error);
            return notAllowedFiles.length > 0 ?
                { 'fileTypes': notAllowedFiles } : null;
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdG9ycy5jbGFzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2lwbGFiL25neC1maWxlLXVwbG9hZC9zcmMvbGliL2hlbHBlcnMvdmFsaWRhdG9ycy5jbGFzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFaEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBY3JEOztHQUVHO0FBQ0gsTUFBTSxhQUFhLEdBQUcsQ0FBQyxVQUFrQixFQUFFLE9BQWUsRUFBRSxVQUFrQixDQUFDLEVBQUUsSUFBVyxFQUEyQixFQUFFO0lBQ3JILE9BQU8sQ0FBQyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxDQUFDO1FBQzlFLEVBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDNUQsQ0FBQyxDQUFDO0FBRUYsTUFBTSxXQUFXLEdBQUcsQ0FBQyxJQUFVLEVBQUUsYUFBcUIsRUFBbUIsRUFBRTtJQUN2RSxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ3ZCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUN2QixPQUFPLElBQXVCLENBQUM7SUFDbkMsQ0FBQztJQUVELE9BQU8sZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQzFDLENBQUMsQ0FBQztBQUVGLElBQUssU0FHSjtBQUhELFdBQUssU0FBUztJQUNWLCtDQUFPLENBQUE7SUFDUCxxREFBVSxDQUFBO0FBQ2QsQ0FBQyxFQUhJLFNBQVMsS0FBVCxTQUFTLFFBR2I7QUFFRCxNQUFNLFlBQVksR0FBRyxhQUFhLENBQUM7QUFDbkM7Ozs7O0dBS0c7QUFDSCxNQUFNLGNBQWMsR0FBRyxDQUFDLElBQVUsRUFBRSxLQUFvQixFQUFFLFNBQW9CLEVBQTJCLEVBQUU7SUFDdkcsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDL0QsTUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztJQUVsRCxLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQ3ZCLE1BQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxJQUFJLGFBQWEsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDekcsSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUNWLE9BQU8sU0FBUyxLQUFLLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBQyxlQUFlLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFDLENBQUM7UUFDckcsQ0FBQztJQUNMLENBQUM7SUFFRCxPQUFPLFNBQVMsS0FBSyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFDLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ2xHLENBQUMsQ0FBQztBQUVGLE1BQU0sY0FBYyxHQUFHLENBQUMsS0FBVSxFQUFTLEVBQUU7SUFDekMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUN4QixNQUFNLEtBQUssQ0FBQywrREFBK0QsS0FBSyxtQ0FBbUMsQ0FBQyxDQUFDO0lBQ3pILENBQUM7QUFDTCxDQUFDLENBQUM7QUFFRixXQUFXO0FBQ1gsTUFBTSxPQUFPLG9CQUFvQjtJQUU3Qjs7T0FFRztJQUNJLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBZTtRQUNuQyxPQUFPLENBQUMsT0FBNEMsRUFBd0MsRUFBRTtZQUMxRixNQUFNLEtBQUssR0FBZ0IsT0FBTyxDQUFDLEtBQUssQ0FBQztZQUN6QyxJQUFJLGFBQWEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUFDLE9BQU8sSUFBSSxDQUFDO1lBQUMsQ0FBQztZQUMxQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFdEIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3BFLE1BQU0sWUFBWSxHQUFHLGFBQWEsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFFakQsT0FBTyxZQUFZLENBQUMsQ0FBQztnQkFDYixFQUFDLFdBQVcsRUFBRSxZQUFZLEVBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQy9DLENBQUMsQ0FBQztJQUNOLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFlO1FBQ2xDLE9BQU8sQ0FBQyxPQUE0QyxFQUF1QyxFQUFFO1lBQ3pGLE1BQU0sS0FBSyxHQUFnQixPQUFPLENBQUMsS0FBSyxDQUFDO1lBQ3pDLElBQUksYUFBYSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQUMsT0FBTyxJQUFJLENBQUM7WUFBQyxDQUFDO1lBQzFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUV0QixNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO2lCQUN2RCxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXRELE9BQU8sWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDeEIsRUFBQyxVQUFVLEVBQUUsWUFBWSxFQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUM5QyxDQUFDLENBQUM7SUFDTixDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksTUFBTSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQTBDO1FBQ2hGLE9BQU8sQ0FBQyxPQUE0QyxFQUF3QyxFQUFFO1lBQzFGLE1BQU0sS0FBSyxHQUFnQixPQUFPLENBQUMsS0FBSyxDQUFDO1lBQ3pDLElBQUksYUFBYSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQUMsT0FBTyxJQUFJLENBQUM7WUFBQyxDQUFDO1lBQzFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUV0QixNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO2lCQUM3RCxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXRELE9BQU8sWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDeEIsRUFBQyxXQUFXLEVBQUUsWUFBWSxFQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUMvQyxDQUFDLENBQUM7SUFDTixDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksTUFBTSxDQUFDLFVBQVUsQ0FBQyxRQUFnQjtRQUNyQyxPQUFPLENBQUMsT0FBNEMsRUFBb0IsRUFBRTtZQUN0RSxNQUFNLEtBQUssR0FBZ0IsT0FBTyxDQUFDLEtBQUssQ0FBQztZQUN6QyxJQUFJLGFBQWEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUFDLE9BQU8sSUFBSSxDQUFDO1lBQUMsQ0FBQztZQUMxQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFdEIsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLENBQUM7aUJBQ3JDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUV6RixPQUFPLEtBQUssQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLENBQUM7Z0JBQzVCLEVBQUMsWUFBWSxFQUFFLFVBQVUsRUFBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDMUMsQ0FBQyxDQUFDO0lBQ04sQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7Ozs7O09BZ0JHO0lBQ0ksTUFBTSxDQUFDLE1BQU0sQ0FBQyxnQkFBK0I7UUFDaEQsT0FBTyxDQUFDLE9BQTRDLEVBQW9CLEVBQUU7WUFDdEUsTUFBTSxLQUFLLEdBQWdCLE9BQU8sQ0FBQyxLQUFLLENBQUM7WUFDekMsSUFBSSxhQUFhLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFBQyxPQUFPLElBQUksQ0FBQztZQUFDLENBQUM7WUFDMUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXRCLE1BQU0sZUFBZSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2lCQUN6RSxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXRELE9BQU8sZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDL0IsRUFBQyxXQUFXLEVBQUUsZUFBZSxFQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUM5QyxDQUFDLENBQUM7SUFDTixDQUFDO0lBRUQ7Ozs7Ozs7Ozs7Ozs7Ozs7T0FnQkc7SUFDSSxNQUFNLENBQUMsTUFBTSxDQUFDLGVBQThCO1FBQy9DLE9BQU8sQ0FBQyxPQUE0QyxFQUFvQixFQUFFO1lBQ3RFLE1BQU0sS0FBSyxHQUFnQixPQUFPLENBQUMsS0FBSyxDQUFDO1lBQ3pDLElBQUksYUFBYSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQUMsT0FBTyxJQUFJLENBQUM7WUFBQyxDQUFDO1lBQzFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUV0QixNQUFNLGVBQWUsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLGVBQWUsRUFBRSxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUM7aUJBQzNFLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFdEQsT0FBTyxlQUFlLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUMvQixFQUFDLFdBQVcsRUFBRSxlQUFlLEVBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQzlDLENBQUMsQ0FBQztJQUNOLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFic3RyYWN0Q29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IHsgSXNOdWxsT3JFbXB0eSB9IGZyb20gJy4vaGVscGVycy5jbGFzcyc7XHJcbmltcG9ydCB7IEZpbGVVcGxvYWRDb250cm9sIH0gZnJvbSAnLi9jb250cm9sLmNsYXNzJztcclxuaW1wb3J0IHsgRmlsZVVwbG9hZFR5cGVzIH0gZnJvbSAnLi9maWxlLXR5cGVzLmNsYXNzJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgVmFsaWRhdGlvbkVycm9yIHtcclxuICAgIGFjdHVhbDogYW55O1xyXG4gICAgZmlsZTogRmlsZTtcclxuICAgIFtrZXk6IHN0cmluZ106IGFueTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBWYWxpZGF0aW9uRXJyb3JzIHtcclxuICAgIFtrZXk6IHN0cmluZ106IGFueTtcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgIFZhbGlkYXRvckZuID0gKGM6IEFic3RyYWN0Q29udHJvbCB8IEZpbGVVcGxvYWRDb250cm9sKSA9PiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbDtcclxuXHJcbi8qKlxyXG4gKiBmdW5jdGlvbiB1c2VkIHRvIGNoZWNrIGZpbGUgc2l6ZVxyXG4gKi9cclxuY29uc3QgY2hlY2tGaWxlU2l6ZSA9IChhY3R1YWxTaXplOiBudW1iZXIsIG1heFNpemU6IG51bWJlciwgbWluU2l6ZTogbnVtYmVyID0gMCwgZmlsZT86IEZpbGUpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCA9PiB7XHJcbiAgICByZXR1cm4gKCFJc051bGxPckVtcHR5KG1heFNpemUpICYmIGFjdHVhbFNpemUgPiBtYXhTaXplKSB8fCBhY3R1YWxTaXplIDwgbWluU2l6ZSA/XHJcbiAgICAgICAge21heFNpemUsIG1pblNpemUsIGFjdHVhbDogYWN0dWFsU2l6ZSwgZmlsZX0gOiBudWxsO1xyXG59O1xyXG5cclxuY29uc3QgZ2V0RmlsZVR5cGUgPSAoZmlsZTogRmlsZSwgZmlsZUV4dGVuc2lvbjogc3RyaW5nKTogRmlsZVVwbG9hZFR5cGVzID0+IHtcclxuICAgIGNvbnN0IHR5cGUgPSBmaWxlLnR5cGU7XHJcbiAgICBpZiAoIUlzTnVsbE9yRW1wdHkodHlwZSkpIHtcclxuICAgICAgICByZXR1cm4gdHlwZSBhcyBGaWxlVXBsb2FkVHlwZXM7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIEZpbGVVcGxvYWRUeXBlc1tmaWxlRXh0ZW5zaW9uXTtcclxufTtcclxuXHJcbmVudW0gQ2hlY2tUeXBlIHtcclxuICAgIEFMTE9XRUQsXHJcbiAgICBOT1RBTExPV0VEXHJcbn1cclxuXHJcbmNvbnN0IEZJTEVfRVhUX1JFRyA9IC8oXlsuXVxcdyopJC9tO1xyXG4vKipcclxuICogZnVuY3Rpb24gdXNlZCB0byBjaGVjayBmaWxlIHR5cGVcclxuICpcclxuICogIyMjIyBhbGxvd2VkVHlwZXNcclxuICogZmlsZV9leHRlbnNpb258YXVkaW8vKnx2aWRlby8qfGltYWdlLyp8bWVkaWFfdHlwZVxyXG4gKi9cclxuY29uc3QgY2hlY2tGaWxlVHlwZXMgPSAoZmlsZTogRmlsZSwgdHlwZXM6IEFycmF5PHN0cmluZz4sIGNoZWNrVHlwZTogQ2hlY2tUeXBlKTogVmFsaWRhdGlvbkVycm9ycyB8IG51bGwgPT4ge1xyXG4gICAgY29uc3QgZmlsZUV4dGVuc2lvbiA9IGZpbGUubmFtZS5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7XHJcbiAgICBjb25zdCBmaWxlVHlwZSA9IGdldEZpbGVUeXBlKGZpbGUsIGZpbGVFeHRlbnNpb24pO1xyXG5cclxuICAgIGZvciAoY29uc3QgdHlwZSBvZiB0eXBlcykge1xyXG4gICAgICAgIGNvbnN0IGlzRm91bmQgPSBGSUxFX0VYVF9SRUcudGVzdCh0eXBlKSA/IHR5cGUgPT09IGAuJHtmaWxlRXh0ZW5zaW9ufWAgOiBuZXcgUmVnRXhwKHR5cGUpLnRlc3QoZmlsZVR5cGUpO1xyXG4gICAgICAgIGlmIChpc0ZvdW5kKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjaGVja1R5cGUgPT09IENoZWNrVHlwZS5BTExPV0VEID8gbnVsbCA6IHtub3RBbGxvd2VkVHlwZXM6IHR5cGVzLCBhY3R1YWw6IGZpbGVUeXBlLCBmaWxlfTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGNoZWNrVHlwZSA9PT0gQ2hlY2tUeXBlLkFMTE9XRUQgPyB7YWxsb3dlZFR5cGVzOiB0eXBlcywgYWN0dWFsOiBmaWxlVHlwZSwgZmlsZX0gOiBudWxsO1xyXG59O1xyXG5cclxuY29uc3QgY2hlY2tWYWx1ZVR5cGUgPSAodmFsdWU6IGFueSApOiB2b2lkID0+IHtcclxuICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcclxuICAgICAgICB0aHJvdyBFcnJvcihgRm9ybUNvbnRyb2wuc2V0VmFsdWUgd2FzIHByb3ZpZGVkIHdpdGggd3JvbmcgYXJndW1lbnQgdHlwZSwgJHt2YWx1ZX0gd2FzIHByb3ZpZGVkIGluc3RlYWQgQXJyYXk8RmlsZT5gKTtcclxuICAgIH1cclxufTtcclxuXHJcbi8vIEBkeW5hbWljXHJcbmV4cG9ydCBjbGFzcyBGaWxlVXBsb2FkVmFsaWRhdG9ycyB7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBWYWxpZGF0b3IgdGhhdCBjb21wYXJlIHRoZSBzdW1tYXJ5IHNpemUgb2YgYWxsIGZpbGVzXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzdGF0aWMgc2l6ZUxpbWl0KG1heFNpemU6IG51bWJlcik6IFZhbGlkYXRvckZuIHtcclxuICAgICAgICByZXR1cm4gKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCB8IEZpbGVVcGxvYWRDb250cm9sKToge3NpemVMaW1pdDogVmFsaWRhdGlvbkVycm9yc30gfCBudWxsID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZmlsZXM6IEFycmF5PEZpbGU+ID0gY29udHJvbC52YWx1ZTtcclxuICAgICAgICAgICAgaWYgKElzTnVsbE9yRW1wdHkoZmlsZXMpKSB7IHJldHVybiBudWxsOyB9XHJcbiAgICAgICAgICAgIGNoZWNrVmFsdWVUeXBlKGZpbGVzKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHN1bSA9IGZpbGVzLm1hcChmaWxlID0+IGZpbGUuc2l6ZSkucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvTGFyZ2VGaWxlcyA9IGNoZWNrRmlsZVNpemUoc3VtLCBtYXhTaXplKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0b0xhcmdlRmlsZXMgP1xyXG4gICAgICAgICAgICAgICAgICAgIHsnc2l6ZUxpbWl0JzogdG9MYXJnZUZpbGVzfSA6IG51bGw7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFZhbGlkYXRvciB0aGF0IHZhbGlkYXRlIGluZGl2aWR1YWxseSBmaWxlIG1heGltdW0gc2l6ZSBsZW5ndGguXHJcbiAgICAgKiBDb21wYXJlIHRoZSBGaWxlIHNpemUgaW4gYnl0ZXNcclxuICAgICAqIEBkeW5hbWljXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzdGF0aWMgZmlsZVNpemUobWF4U2l6ZTogbnVtYmVyKTogVmFsaWRhdG9yRm4ge1xyXG4gICAgICAgIHJldHVybiAoY29udHJvbDogQWJzdHJhY3RDb250cm9sIHwgRmlsZVVwbG9hZENvbnRyb2wpOiB7ZmlsZVNpemU6IEFycmF5PFZhbGlkYXRpb25FcnJvcnM+fSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpbGVzOiBBcnJheTxGaWxlPiA9IGNvbnRyb2wudmFsdWU7XHJcbiAgICAgICAgICAgIGlmIChJc051bGxPckVtcHR5KGZpbGVzKSkgeyByZXR1cm4gbnVsbDsgfVxyXG4gICAgICAgICAgICBjaGVja1ZhbHVlVHlwZShmaWxlcyk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB0b0xhcmdlRmlsZXMgPSBmaWxlcy5tYXAoKGZpbGUpID0+IGNoZWNrRmlsZVNpemUoZmlsZS5zaXplLCBtYXhTaXplLCAwLCBmaWxlKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKGVycm9yKSA9PiBlcnJvcik7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdG9MYXJnZUZpbGVzLmxlbmd0aCA+IDAgP1xyXG4gICAgICAgICAgICAgICAgICAgIHsnZmlsZVNpemUnOiB0b0xhcmdlRmlsZXN9IDogbnVsbDtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ29tcGFyZSB0aGUgRmlsZSBzaXplIGluIGJ5dGVzIHdpdGggbWF4IGFuZCBtaW4gc2l6ZSBsaW1pdHNcclxuICAgICAqIEBkeW5hbWljXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzdGF0aWMgc2l6ZVJhbmdlKHsgbWluU2l6ZSwgbWF4U2l6ZSB9OiB7IG1pblNpemU/OiBudW1iZXI7IG1heFNpemU/OiBudW1iZXIgfSk6IFZhbGlkYXRvckZuIHtcclxuICAgICAgICByZXR1cm4gKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCB8IEZpbGVVcGxvYWRDb250cm9sKToge3NpemVSYW5nZTogQXJyYXk8VmFsaWRhdGlvbkVycm9ycz59ID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZmlsZXM6IEFycmF5PEZpbGU+ID0gY29udHJvbC52YWx1ZTtcclxuICAgICAgICAgICAgaWYgKElzTnVsbE9yRW1wdHkoZmlsZXMpKSB7IHJldHVybiBudWxsOyB9XHJcbiAgICAgICAgICAgIGNoZWNrVmFsdWVUeXBlKGZpbGVzKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHNpemVNaXNtYXRjaCA9IGZpbGVzLm1hcCgoZmlsZSkgPT4gY2hlY2tGaWxlU2l6ZShmaWxlLnNpemUsIG1heFNpemUsIG1pblNpemUsIGZpbGUpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcigoZXJyb3IpID0+IGVycm9yKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBzaXplTWlzbWF0Y2gubGVuZ3RoID4gMCA/XHJcbiAgICAgICAgICAgICAgICAgICAgeydzaXplUmFuZ2UnOiBzaXplTWlzbWF0Y2h9IDogbnVsbDtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogdmFsaWRhdG9yIHRoYXQgcmVxdWlyZXMgY29udHJvbCB0byBoYXZlIGxpbWl0IG9uIGZpbGVzIG51bWJlclxyXG4gICAgICogQGR5bmFtaWNcclxuICAgICAqL1xyXG4gICAgcHVibGljIHN0YXRpYyBmaWxlc0xpbWl0KG51bUZpbGVzOiBudW1iZXIpOiBWYWxpZGF0b3JGbiB7XHJcbiAgICAgICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wgfCBGaWxlVXBsb2FkQ29udHJvbCk6IFZhbGlkYXRpb25FcnJvcnMgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBmaWxlczogQXJyYXk8RmlsZT4gPSBjb250cm9sLnZhbHVlO1xyXG4gICAgICAgICAgICBpZiAoSXNOdWxsT3JFbXB0eShmaWxlcykpIHsgcmV0dXJuIG51bGw7IH1cclxuICAgICAgICAgICAgY2hlY2tWYWx1ZVR5cGUoZmlsZXMpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgZmlsZXNMaW1pdCA9IGZpbGVzLnNsaWNlKC0xICogKGZpbGVzLmxlbmd0aCAtIG51bUZpbGVzKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChmaWxlID0+ICh7J21heCc6IG51bUZpbGVzLCAnYWN0dWFsJzogZmlsZXMubGVuZ3RoLCBmaWxlIH0pKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBmaWxlcy5sZW5ndGggPiBudW1GaWxlcyA/XHJcbiAgICAgICAgICAgICAgICB7J2ZpbGVzTGltaXQnOiBmaWxlc0xpbWl0fSA6IG51bGw7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIHZhbGlkYXRvciB0aGF0IHJlcXVpcmVzIGNvbnRyb2wgdG8gaGF2ZSBsaW1pdCBvbiBtZWRpYSB0eXBlc1xyXG4gICAgICpcclxuICAgICAqICMjIyMjIEFsbG93ZWQgbWVkaWEgdHlwZXMgYXJlXHJcbiAgICAgKlxyXG4gICAgICogLSBmaWxlX2V4dGVuc2lvbiAtIGEgZmlsZSBleHRlbnNpb24gc3RhcnRpbmcgd2l0aCB0aGUgU1RPUCBjaGFyYWN0ZXIsXHJcbiAgICAgKiBlLmc6IC5naWYsIC5qcGcsIC5wbmcsIC5kb2NcclxuICAgICAqIC0gYXVkaW8vKiAtICAgICAgICBBbGwgc291bmQgZmlsZXMgYXJlIGFjY2VwdGVkXHJcbiAgICAgKiAtIHZpZGVvLyogLSAgICAgICAgQWxsIHZpZGVvIGZpbGVzIGFyZSBhY2NlcHRlZFxyXG4gICAgICogLSBpbWFnZS8qIC0gICAgICAgIEFsbCBpbWFnZSBmaWxlcyBhcmUgYWNjZXB0ZWRcclxuICAgICAqIC0gbWVkaWFfdHlwZSAtICAgICBBIHZhbGlkIG1lZGlhIHR5cGUsIHdpdGggbm8gcGFyYW1ldGVycy4gTG9vayBhdCBbSUFOQSBNZWRpYSBUeXBlc11cclxuICAgICAqICAgICAgKGh0dHBzOi8vd3d3LmlhbmEub3JnL2Fzc2lnbm1lbnRzL21lZGlhLXR5cGVzL21lZGlhLXR5cGVzLnhodG1sKSBmb3IgYSBjb21wbGV0ZSBsaXN0IG9mIHN0YW5kYXJkIG1lZGlhIHR5cGVzXHJcbiAgICAgKlxyXG4gICAgICogIyMjIyBFeGFtcGxlXHJcbiAgICAgKiBgRmlsZVVwbG9hZFZhbGlkYXRvcnMuYWNjZXB0KFtmaWxlX2V4dGVuc2lvbiwgYXVkaW8vKiwgdmlkZW8vKiwgaW1hZ2UvKiwgbWVkaWFfdHlwZV0pYFxyXG4gICAgICogQGR5bmFtaWNcclxuICAgICAqL1xyXG4gICAgcHVibGljIHN0YXRpYyBhY2NlcHQoYWxsb3dlZEZpbGVUeXBlczogQXJyYXk8c3RyaW5nPik6IFZhbGlkYXRvckZuIHtcclxuICAgICAgICByZXR1cm4gKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCB8IEZpbGVVcGxvYWRDb250cm9sKTogVmFsaWRhdGlvbkVycm9ycyA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpbGVzOiBBcnJheTxGaWxlPiA9IGNvbnRyb2wudmFsdWU7XHJcbiAgICAgICAgICAgIGlmIChJc051bGxPckVtcHR5KGZpbGVzKSkgeyByZXR1cm4gbnVsbDsgfVxyXG4gICAgICAgICAgICBjaGVja1ZhbHVlVHlwZShmaWxlcyk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBub3RBbGxvd2VkRmlsZXMgPSBmaWxlcy5tYXAoKGZpbGUpID0+IGNoZWNrRmlsZVR5cGVzKGZpbGUsIGFsbG93ZWRGaWxlVHlwZXMsIENoZWNrVHlwZS5BTExPV0VEKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKGVycm9yKSA9PiBlcnJvcik7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbm90QWxsb3dlZEZpbGVzLmxlbmd0aCA+IDAgP1xyXG4gICAgICAgICAgICAgICAgeydmaWxlVHlwZXMnOiBub3RBbGxvd2VkRmlsZXN9IDogbnVsbDtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogdmFsaWRhdG9yIHRoYXQgcmVxdWlyZXMgY29udHJvbCB0byBoYXZlIGxpbWl0IG9uIG1lZGlhIHR5cGVzXHJcbiAgICAgKlxyXG4gICAgICogIyMjIyMgTm90IGFsbG93ZWQgbWVkaWEgdHlwZXMgYXJlXHJcbiAgICAgKlxyXG4gICAgICogLSBmaWxlX2V4dGVuc2lvbiAtIGEgZmlsZSBleHRlbnNpb24gc3RhcnRpbmcgd2l0aCB0aGUgU1RPUCBjaGFyYWN0ZXIsXHJcbiAgICAgKiBlLmc6IC5naWYsIC5qcGcsIC5wbmcsIC5kb2NcclxuICAgICAqIC0gYXVkaW8vKiAtICAgICAgICBBbGwgc291bmQgZmlsZXMgYXJlIGFjY2VwdGVkXHJcbiAgICAgKiAtIHZpZGVvLyogLSAgICAgICAgQWxsIHZpZGVvIGZpbGVzIGFyZSBhY2NlcHRlZFxyXG4gICAgICogLSBpbWFnZS8qIC0gICAgICAgIEFsbCBpbWFnZSBmaWxlcyBhcmUgYWNjZXB0ZWRcclxuICAgICAqIC0gbWVkaWFfdHlwZSAtICAgICBBIHZhbGlkIG1lZGlhIHR5cGUsIHdpdGggbm8gcGFyYW1ldGVycy4gTG9vayBhdCBbSUFOQSBNZWRpYSBUeXBlc11cclxuICAgICAqICAgICAgKGh0dHBzOi8vd3d3LmlhbmEub3JnL2Fzc2lnbm1lbnRzL21lZGlhLXR5cGVzL21lZGlhLXR5cGVzLnhodG1sKSBmb3IgYSBjb21wbGV0ZSBsaXN0IG9mIHN0YW5kYXJkIG1lZGlhIHR5cGVzXHJcbiAgICAgKlxyXG4gICAgICogIyMjIyBFeGFtcGxlXHJcbiAgICAgKiBgRmlsZVVwbG9hZFZhbGlkYXRvcnMucmVqZWN0KFtmaWxlX2V4dGVuc2lvbiwgYXVkaW8vKiwgdmlkZW8vKiwgaW1hZ2UvKiwgbWVkaWFfdHlwZV0pYFxyXG4gICAgICogQGR5bmFtaWNcclxuICAgICAqL1xyXG4gICAgcHVibGljIHN0YXRpYyByZWplY3QocmVqZWN0RmlsZVR5cGVzOiBBcnJheTxzdHJpbmc+KTogVmFsaWRhdG9yRm4ge1xyXG4gICAgICAgIHJldHVybiAoY29udHJvbDogQWJzdHJhY3RDb250cm9sIHwgRmlsZVVwbG9hZENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZmlsZXM6IEFycmF5PEZpbGU+ID0gY29udHJvbC52YWx1ZTtcclxuICAgICAgICAgICAgaWYgKElzTnVsbE9yRW1wdHkoZmlsZXMpKSB7IHJldHVybiBudWxsOyB9XHJcbiAgICAgICAgICAgIGNoZWNrVmFsdWVUeXBlKGZpbGVzKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IG5vdEFsbG93ZWRGaWxlcyA9IGZpbGVzLm1hcCgoZmlsZSkgPT4gY2hlY2tGaWxlVHlwZXMoZmlsZSwgcmVqZWN0RmlsZVR5cGVzLCBDaGVja1R5cGUuTk9UQUxMT1dFRCkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKChlcnJvcikgPT4gZXJyb3IpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG5vdEFsbG93ZWRGaWxlcy5sZW5ndGggPiAwID9cclxuICAgICAgICAgICAgICAgIHsnZmlsZVR5cGVzJzogbm90QWxsb3dlZEZpbGVzfSA6IG51bGw7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbn1cclxuIl19